<!doctype html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
    <script src="https://unpkg.com/hyperscript.org@latest"></script>
    <script src="static/dist/eventsource.js"></script>
    <title>{{ .title }}</title>
</head>

<body>
    <main class="container">
        <h1>{{ .title }}</h1>
        <p>There is currently <strong id="rooms-count">{{ .roomCount }}</strong> open room{{ .roomCount | plural }}.</p>
        <button _="on click fetch /room/new {method: 'POST'}">New Room</button>
        <div id="rooms-list">
            {{ template "index/list" .}}
        </div>
    </main>
</body>

<script type="text/hyperscript">
    init
        set $count to {{ .roomCount }}
    end
</script>

<script type="text/hyperscript">
    def listUpdate()
        fetch "/room/list" then put the result into the #rooms-list
    end

    eventsource ChatUpdates from /stream/global

    on rooms as string
        if result is "deleted"
            decrement $count by 1
        else
            increment $count by 1
        end
        put $count into the #rooms-count
        listUpdate()
    end

    on open
        log "connection opened."
    end

    end
</script>

</html>